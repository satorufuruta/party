# クイズアプリ開発シーケンス

## 目的
要件定義書 (`requirements.md`) をもとに、リアルタイムクイズアプリを Cloudflare プラットフォーム上で構築するための実装シーケンスを整理する。各フェーズのアウトカムと依存関係を明確にし、スムーズな開発進行を支援する。

## フェーズ一覧
| フェーズ | ゴール | 主なアウトプット |
| --- | --- | --- |
| 01. 要件精査とドメイン設計 | クイズ進行フロー・リアルタイム要件を具体化し、ステートモデルを定義する | イベントシナリオ、状態遷移図、メッセージ仕様書 |
| 02. インフラ下準備 | Cloudflare 環境とローカル開発フローを整備する | `wrangler.toml` 初期設定、`package.json` スクリプト、環境ドキュメント |
| 03. データ層構築 | D1 スキーマとデータアクセスの基礎を固める | SQL マイグレーション、DAO/リポジトリ骨子、シードデータ方針 |
| 04. Durable Object 実装 | リアルタイム進行の中核ロジックを実装する | QuizRoom DO、状態同期・タイマー制御コード、単体テスト |
| 05. HTTP API 実装 | REST API で管理系操作・結果参照を提供する | Cloudflare Functions、API ハンドラ、DO/D1 連携テスト |
| 06. リアルタイム連携 | WebSocket プロトコルをクライアントに接続する | クライアント SDK、メッセージハンドラ、再接続シナリオ検証 |
| 07. 管理画面 UI | 進行管理と結果閲覧の UI を構築する | Next.js ページ、状態管理、API/WebSocket 結線 |
| 08. 参加者 UI | 参加・回答・結果表示体験を完成させる | 参加ページ、回答送信 UI、制限時間/再同期機能 |
| 09. 統合テストとデプロイ | 全体の品質と運用準備を整える | 統合テスト、負荷検証、デプロイ設定、運用手順 |

## 詳細シーケンス
1. **要件精査とドメイン設計**
   - タイマー挙動、問題進行、再接続時の挙動をシーケンス図で可視化。
   - Durable Object が保持する状態（問題番号、残り時間、参加者一覧など）のフィールド定義を確定。
   - WebSocket/HTTP メッセージ仕様を決定し、エラーケースを洗い出す。
2. **インフラ下準備**
   - Cloudflare プロジェクトのバインディング（Durable Objects、D1、環境変数）を `wrangler.toml` に集約。
   - `package.json` の `scripts` に開発サーバー起動、テスト、デプロイなどのコマンドを整理。
   - README に開発手順や `wrangler` のセットアップを追記。
3. **データ層構築**
   - D1 用のマイグレーションファイルを作成し、`users/quizzes/questions/choices/answers` テーブルを定義。
   - データアクセスユーティリティ（DAO/Repository）を作成し、Cloudflare 環境での利用方針をまとめる。
   - 初期データ投入やテスト用モックの準備を行う。
4. **Durable Object 実装**
   - QuizRoom Durable Object を実装し、参加者接続、問題開始・終了、タイマー管理を担うメソッドを実装。
   - 再接続時に最新状態を返すレジューム処理と、WebSocket メッセージのルーティングを整備。
   - 振る舞いをカバーする単体テストやシミュレーションスクリプトで検証。
5. **HTTP API 実装**
   - クイズ作成・更新・セッション開始・結果取得などの REST エンドポイントを Cloudflare Functions で実装。
   - Durable Object や D1 とのやり取りをカプセル化し、エラーハンドリング方針を整理。
   - API レベルの結合テストを用意し、モックセッションでの動作を確認。
6. **リアルタイム連携**
   - WebSocket クライアント用の共通ユーティリティを実装し、Next.js から利用できるようにする。
   - `question_locked` や `question_reveal` 等のメッセージハンドラを定義し、UI で扱いやすいイベントに変換。
   - 切断/再接続、タイムアウトなどのシナリオをテスト。
7. **管理画面 UI**
   - セッション開始、現在の問題表示、参加者ステータスなどのビューを構築。
   - 自動進行と手動介入を切り替える操作系を設置し、リアルタイム更新を反映。
   - 進行ログや結果表示タブなど、管理者体験を整える。
8. **参加者 UI**
   - 参加用 URL にアクセスした際の認証/識別処理とセッション参加フローを実装。
   - 問題表示、制限時間カウントダウン、回答送信、結果表示をリアルタイムに更新。
   - 再接続時に最新状態へ追従する復帰処理を確認。
9. **統合テストとデプロイ**
   - ローカル (wrangler dev) と Cloudflare 環境の双方で統合テストを実施し、負荷・遅延要件を検証。
   - 自動化可能なテスト（ユニット、結合、E2E）を整備し、CI/CD パイプラインへの組み込みを検討。
   - Pages/Workers へのデプロイ設定を確立し、運用手順とトラブルシュートガイドを用意。

## 依存関係と前提
- フェーズ 04 以降は Durable Object の状態設計が確定していることが前提。
- フェーズ 05 の API は D1 スキーマと DO のインターフェースに依存するため、先行フェーズでの定義凍結が必要。
- UI 実装フェーズ (07/08) はリアルタイム連携フェーズ (06) のクライアント SDK が利用できることを前提とする。

## 次の推奨ステップ
1. 状態遷移図とメッセージプロトコルのドラフトを作成し、ステークホルダーと合意形成。
2. `wrangler.toml` と `package.json` のスクリプト下地を整備し、ローカル開発環境を確立。
3. D1 マイグレーションの雛形を作成し、開発初期からデータ定義を共有。
